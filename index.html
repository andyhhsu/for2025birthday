<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一個只屬於妳的挑戰</title>
    <!-- 快取清除 V4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* --- 整體頁面樣式 --- */
        :root {
            --bg-color: #282a36;
            --container-bg: #44475a;
            --text-color: #f8f8f2;
            --primary-color: #ff79c6;
            --secondary-color: #f1fa8c;
            --accent-color: #50fa7b;
            --border-color: #bd93f9;
            --error-color: #ff5555;
        }
        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Georgia', 'Times New Roman', serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            overflow: hidden; /* 隱藏捲軸，讓背景更完整 */
        }

        /* 動態背景畫布 */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* 確保在最底層 */
        }
        
        .container {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.5s ease;
            z-index: 1;
        }

        h1, h2 { color: var(--primary-color); }
        h1 { font-size: 1.8em; }
        p { line-height: 1.8; font-size: 1.1em; }

        .riddle {
            font-style: italic;
            color: var(--secondary-color);
            background-color: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .input-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #answer-input {
            padding: 12px;
            border-radius: 5px;
            border: 2px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1em;
            text-align: center;
            width: 100%;
            max-width: 300px;
            transition: all 0.3s ease;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            max-width: 300px;
        }
        button:hover { opacity: 0.9; transform: scale(1.02); }

        #clue-tracker {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            font-size: 1em;
            letter-spacing: 2px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
            text-align: center;
        }
        .container { margin-top: 60px; }

        .success-view img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid var(--accent-color);
        }
        .success-view .personal-note { font-style: italic; font-size: 1.2em; color: #8affc1; }
        .success-view .clue-reveal { font-size: 1.5em; color: var(--secondary-color); font-weight: bold; }
        
        /* 最終單字遊戲樣式 */
        .letter-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 5px; }
        .letter-tile { background-color: var(--secondary-color); color: var(--bg-color); width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; }
        .letter-tile:hover { transform: scale(1.1); }
        .letter-tile.used { opacity: 0.2; pointer-events: none; }
        .answer-slots-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin: 20px 0; }
        .answer-word { display: flex; gap: 5px; }
        .answer-slot { width: 35px; height: 45px; background-color: var(--bg-color); border: 2px solid var(--border-color); border-radius: 5px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; color: var(--text-color); font-weight: bold; cursor: pointer; }
        
        hr { border: none; border-top: 1px solid var(--border-color); margin: 30px 0; }

        /* 答題反饋動畫 */
        .shake { animation: shake-horizontal 0.5s ease-in-out; }
        .correct-flash { animation: correct-flash 0.5s ease-in-out; }
        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        @keyframes correct-flash {
            0%, 100% { box-shadow: 0 0 10px var(--accent-color); }
            50% { box-shadow: 0 0 25px var(--accent-color); }
        }

        /* 最終揭曉動畫 */
        #gift-location { opacity: 0; transition: opacity 1s ease-in-out; }
        #gift-location.revealed { opacity: 1; }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="clue-tracker">線索碎片：<span id="clue-display"></span></div>
    <div class="container" id="main-container"></div>

    <script>
        // ===================================================================================
        // ============================  遊戲資料庫 & 個人化設定  ============================
        // ===================================================================================

        const yourName = "你的名字"; // 【請修改】

        const puzzleData = [
            {
                riddle: "年份，是我們記憶中最後一個可以自由呼吸、無需口罩的完整年份。而日期，在俄羅斯，這一天是紀念勝利的『勝利日』。",
                answer: ["20190509", "2019/05/09"],
                clues: ["E", "S"],
                photo: null,
                note: "從那天起，我們之間，日日是好日。"
            },
            {
                riddle: "這道謎題，無關異國風情，只關乎一個重要的『第一次』。為了慶祝你的第一個生日，我訂的餐廳不是牛排，也不是義大利麵。請問，那個為我們揭開無數慶祝序幕的二字料理『風格』是什麼？",
                answer: "泰式",
                clues: ["T", "O"],
                photo: "photo2.jpg",
                note: "那天的主角是你，但最秀色可餐的也是你。"
            },
            {
                riddle: "我們的首次旅行。那座城市被現代人戲稱為『一個適合眾神居住、卻不太適合人類工作的奇幻之地』，並且，它是台灣六都之中，至今唯一沒有捷運系統通車的直轄市。這座步調獨特的城市是？",
                answer: "台南",
                clues: ["W", "O"],
                photo: "photo3.jpg",
                note: "我們旅程的起點，也是故事的序篇。"
            },
            {
                riddle: "這道謎題，關於我們最平凡也最珍貴的日常。無論是在公園的草地上，還是在河堤的夕陽下，總有『他』的身影陪著我們散步。請問，我們最棒的散步夥伴，他的五個字母英文名字是？",
                answer: "Sunny",
                clues: ["D", "I"],
                photo: "photo4.jpg",
                note: "我們生命中最溫暖、最療癒的存在。"
            },
            {
                riddle: "關於我們的第一次出國旅行。比起大阪的章魚燒和京都的清水寺，我猜你印象最深的，應該是在奈良被鹿『追殺』的陰影吧？請問，這個讓你留下爆笑陰影的二字國度是哪裡？",
                answer: "日本",
                clues: ["W", "E"],
                photo: "photo5.jpg",
                note: "希望奈良的鹿，沒有在你心裡留下太大的陰影（笑）。"
            },
            {
                riddle: "那場演唱會，對我們來說不只是一晚的狂歡，而是一個『新篇章』的開始。從那天起，一起追蹤她們的新歌、看她们的消息，成了我們之間的一個新默契。請問，開啟了我們這個共同話題的團體，其名稱為何？",
                answer: "babymonster",
                clues: ["N", "N"],
                photo: "photo6.jpg",
                note: "陪你一起聲嘶力竭，是我做過最搖滾的事。"
            },
            {
                riddle: "那款充滿了我們共同焦慮的遊戲。它的背景音樂，就是我們互相大喊『飯燒焦了！』和『盤子在哪？！』的聲音。遊戲的單一英文詞標題，完美描述了我們 90% 的料理成品最終的狀態。它是什麼？",
                answer: "overcooked",
                clues: ["E"],
                photo: null,
                note: "就算手忙腳亂，我們依然是彼此的最佳拍檔。"
            },
            {
                riddle: "我們對一個角色的愛，可以體現在很多地方。從追遍各地的快閃店，到收集越來越多的週邊，最經典的還是那次路跑——我們興沖沖地報了名，結果天氣一熱，直接變成他的個人拍照會。請問，這位讓我們心甘情願為他做這麼多傻事的綠色夥伴，他的英文名字是？",
                answer: "joguman",
                clues: ["V"],
                photo: "photo8.jpg",
                note: "為了他做的傻事，現在回想起來都覺得好可愛。"
            },
            {
                riddle: "我們共同達到的最高點。從那裡俯瞰，腳下的城市像一塊精密的電路板，河流是閃爍的銀色焊錫。這座建築坐落於首爾一個巨大的複合園區內，旁邊就是一座著名的室內遊樂園。它的三字名稱是？",
                answer: "樂天塔",
                clues: ["I"],
                photo: "photo9.jpg",
                note: "和你一起看過的風景，永遠是最美的。"
            },
            {
                riddle: "那趟外島之旅，白天熱得讓人懷疑人生，但夜晚卻給了我們最棒的驚喜。我們站在漆黑的海邊，看著浪花拍打出藍色的螢光，留下了那張珍貴的合照。請問，那片成為我們最夢幻合照背景的奇景，它的三字名稱是什麼？",
                answer: "藍眼淚",
                clues: ["V"],
                photo: "photo10.jpg",
                note: "那片藍色的海，是我們今年最棒的驚喜。"
            }
        ];

        const finalAnswer = { part1: "vivienne", part2: "westwood" };
        const finalGiftLocation = "臥室的書櫃第三層"; // 【請務必修改這裡】

        // 音效模組
        const sounds = {
            correct: new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
            incorrect: new Tone.Synth({ oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(),
            place: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination()
        };
        function playSound(type) {
            if (Tone.context.state !== 'running') { Tone.start(); }
            if (type === 'correct') sounds.correct.triggerAttackRelease("C5", "8n");
            if (type === 'incorrect') sounds.incorrect.triggerAttackRelease("C3", "8n");
            if (type === 'place') sounds.place.triggerAttackRelease("C2", "8n");
        }

        // 背景動畫
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        let stars = [];
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        function createStars() {
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, radius: Math.random() * 1.5, alpha: Math.random(), dAlpha: Math.random() * 0.01 - 0.005 });
            }
        }
        function animateStars() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                star.alpha += star.dAlpha;
                if (star.alpha <= 0 || star.alpha >= 1) star.dAlpha *= -1;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(248, 248, 242, ${star.alpha})`;
                ctx.fill();
            });
            requestAnimationFrame(animateStars);
        }
        window.addEventListener('resize', () => { resizeCanvas(); createStars(); });
        resizeCanvas(); createStars(); animateStars();

        // 遊戲核心邏輯
        const mainContainer = document.getElementById('main-container');
        let gameState = { currentPuzzle: 0, completedPuzzles: [], collectedClues: [] };

        function saveGame() { localStorage.setItem('birthdayPuzzleState', JSON.stringify(gameState)); }
        function loadGame() {
            const savedState = localStorage.getItem('birthdayPuzzleState');
            if (savedState) gameState = JSON.parse(savedState);
        }

        function updateClueTracker() {
            const display = document.getElementById('clue-display');
            let clueText = "";
            const totalClues = 16;
            for (let i = 0; i < totalClues; i++) {
                clueText += (i < gameState.collectedClues.length ? gameState.collectedClues[i] : "_") + " ";
            }
            display.textContent = clueText.trim();
        }

        function renderPuzzle(index) {
            let content = '';
            if (index === 0 && (!localStorage.getItem('birthdayPuzzleState') || JSON.parse(localStorage.getItem('birthdayPuzzleState')).completedPuzzles.length === 0)) {
                content += `<h1>親愛的 Christine，</h1><p>在準備妳生日的這段日子裡，我一直在回想我們的點點滴滴。<br>有些很傻，有些很溫暖，每一個都是構成「我們」的無價之寶。</p><p>我把其中我最珍愛的十個瞬間，變成了這份小小的挑戰，想邀請妳和我一起重溫。</p><p><strong>這不是什麼複雜的遊戲，只是我想用一個特別的方式，和妳聊聊天，看看我們之間的心靈感應有多強。</strong></p><p>每答對一題，就代表我們又找回了一段共同的回憶，<br>同時妳會得到一枚「線索碎片」。當所有碎片集齊時，就是我揭曉禮物的時刻。</p><p>生日快樂，我最愛的人。準備好開始了嗎？</p><hr>`;
            }
            const puzzle = puzzleData[index];
            content += `<h2>第 ${index + 1} 題</h2><p class="riddle">${puzzle.riddle}</p><div class="input-area"><input type="text" id="answer-input" placeholder="請在此輸入答案..." onkeydown="if(event.key==='Enter') checkAnswer()"><button onclick="checkAnswer()">提交答案</button></div>`;
            mainContainer.innerHTML = content;
            const inputField = document.getElementById('answer-input');
            if (inputField) inputField.focus();
        }
        
        function renderSuccessView(index) {
            const puzzle = puzzleData[index];
            const cacheBuster = new Date().getTime(); // 建立一個獨一無二的時間戳
            // 【快取修正】在圖片檔名後面加上 ?v=時間戳
            const photoHTML = puzzle.photo ? `<img src="${puzzle.photo}?v=${cacheBuster}" alt="回憶照片">` : '';
            mainContainer.innerHTML = `<div class="success-view"><h2>記憶鎖定解除。妳證明了自己。</h2><p>一段塵封的時光，被妳親手還原了。</p>${photoHTML}<p class="personal-note">“${puzzle.note}”</p><p>這是妳應得的獎勵... 一枚關鍵的「線索碎片」：</p><p class="clue-reveal">${puzzle.clues.join(', ')}</p><hr><button onclick="nextStep()">> 前往下一道詰問</button></div>`;
        }

        function checkAnswer() {
            const index = gameState.currentPuzzle;
            const userInput = document.getElementById('answer-input').value.trim();
            const inputElement = document.getElementById('answer-input');
            const correctAnswers = puzzleData[index].answer;
            
            let isCorrect = false;
            if (Array.isArray(correctAnswers)) {
                isCorrect = correctAnswers.some(ans => userInput.toLowerCase() === ans.toLowerCase());
            } else {
                isCorrect = userInput.toLowerCase() === correctAnswers.toLowerCase();
            }

            if (isCorrect) {
                playSound('correct');
                inputElement.classList.add('correct-flash');

                if (!gameState.completedPuzzles.includes(index)) {
                    const newClues = puzzleData[index].clues;
                    gameState.collectedClues.push(...newClues);
                    gameState.completedPuzzles.push(index);
                }
                
                setTimeout(() => {
                    updateClueTracker();
                    renderSuccessView(index);
                    saveGame();
                }, 600);
            } else {
                playSound('incorrect');
                inputElement.classList.add('shake');
                inputElement.value = "";
                setTimeout(() => inputElement.classList.remove('shake'), 500);
            }
        }

        function nextStep() {
            gameState.currentPuzzle++;
            if (gameState.currentPuzzle < puzzleData.length) {
                renderPuzzle(gameState.currentPuzzle);
            } else {
                renderFinale();
            }
            saveGame();
        }
        
        function renderFinale() {
            let shuffledClues = [...gameState.collectedClues].sort(() => Math.random() - 0.5);
            let letterTilesHTML = shuffledClues.map((letter, i) => 
                `<div class="letter-tile" id="tile-${i}" onclick="selectLetter(this, '${letter}')">${letter}</div>`
            ).join('');

            let answerSlotsHTML = `
                <div class="answer-word" id="word1">
                    ${Array(8).fill('<div class="answer-slot" onclick="returnLetter(this)"></div>').join('')}
                </div>
                <div class="answer-word" id="word2">
                    ${Array(8).fill('<div class="answer-slot" onclick="returnLetter(this)"></div>').join('')}
                </div>
            `;

            mainContainer.innerHTML = `<h2>恭喜通關，我的記憶主人。</h2><p>妳憑藉著智慧與默契，成功還原了所有被我藏起來的珍貴回憶，<br>證明了妳是它們唯一的主人。</p><p>現在，只剩下最後一道鎖。<br>解開它，就能找到我為妳準備的真正驚喜。</p><hr><p>請用妳收集到的 16 枚線索碎片，拼出最終的答案：</p><div class="letter-pool">${letterTilesHTML}</div><p><strong>最後的提示：</strong> 這是一個工整的「<strong>8+8</strong>」組合，就像它的品牌 Logo 一樣，對稱而又充滿個性。答案本身，充滿了英倫的搖滾精神喔。</p><div class="answer-slots-container">${answerSlotsHTML}</div><div class="input-area"><button onclick="checkFinalAnswer()">揭曉最終答案</button></div>`;
        }

        function selectLetter(tileElement, letter) {
            playSound('place');
            const allSlots = document.querySelectorAll('.answer-slot');
            let emptySlot = Array.from(allSlots).find(slot => slot.textContent === '');
            
            if (emptySlot) {
                emptySlot.textContent = letter;
                emptySlot.dataset.tileId = tileElement.id;
                tileElement.classList.add('used');
            }
        }

        function returnLetter(slotElement) {
            playSound('place');
            const tileId = slotElement.dataset.tileId;
            if (tileId) {
                const tileElement = document.getElementById(tileId);
                tileElement.classList.remove('used');
                slotElement.textContent = '';
                delete slotElement.dataset.tileId;
            }
        }

        function checkFinalAnswer() {
            const slots1 = document.querySelectorAll('#word1 .answer-slot');
            const slots2 = document.querySelectorAll('#word2 .answer-slot');
            const word1 = Array.from(slots1).map(slot => slot.textContent).join('').toLowerCase();
            const word2 = Array.from(slots2).map(slot => slot.textContent).join('').toLowerCase();

            if (word1 === finalAnswer.part1 && word2 === finalAnswer.part2) {
                playSound('correct');
                mainContainer.innerHTML = `<h1>完全正確！</h1><h2>生日快樂，我生命中唯一的主角。</h2><p>這十個碎片，只是我們故事的序章。<br>接下來，還有無數的空白等著我們一起填滿。</p><hr><div class="input-area"><button id="reveal-button" onclick="revealGift()">> 揭曉我的最終獎勵</button></div>`;
            } else {
                playSound('incorrect');
                alert("不對喔，再檢查一下拼字！");
            }
        }
        
        function revealGift() {
            const button = document.getElementById('reveal-button');
            const giftText = document.createElement('p');
            giftText.id = 'gift-location';
            giftText.className = 'personal-note';
            giftText.style.fontSize = '1.5em';
            giftText.textContent = `現在，請前往 ${finalGiftLocation}，領取屬於妳的搖滾徽章吧！`;

            const signature = document.createElement('p');
            signature.textContent = `—— 不再是竊賊，而是永遠愛妳的，${yourName}`;
            
            button.replaceWith(giftText);
            mainContainer.appendChild(document.createElement('hr'));
            mainContainer.appendChild(signature);

            setTimeout(() => {
                giftText.classList.add('revealed');
            }, 100);

            localStorage.removeItem('birthdayPuzzleState');
        }

        // --- 遊戲初始化 ---
        loadGame();
        if (gameState.currentPuzzle >= puzzleData.length) {
            renderFinale();
        } else {
            renderPuzzle(gameState.currentPuzzle);
        }
        updateClueTracker();
        
        // 供您自己測試用的重設功能 (在瀏覽器開發者工具的Console中輸入 resetGame() 來使用)
        function resetGame() { if (confirm("確定要重設所有遊戲進度嗎？")) { localStorage.removeItem('birthdayPuzzleState'); location.reload(); } }
    </script>
</body>
</html>

